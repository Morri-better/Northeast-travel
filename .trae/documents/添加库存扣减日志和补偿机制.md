# 添加库存扣减日志和补偿机制

## 1. 创建StockDeductLogMapper接口

在 `mapper` 包中创建 `StockDeductLogMapper.java`，包含：

* `upsertFail()` - 失败记录写入/更新（幂等upsert + 退避策略）

* `markSuccess()` - 标记成功

* `pickDue()` - 捞取到期需要补偿的记录（定时任务使用）

* `markRetrying()` - 标记重试中

## 2. 创建StockDeductLogService服务类

在 `service` 包中创建 `StockDeductLogService.java`，包含：

* `recordFail()` - 记录失败（独立事务）

* `markSuccess()` - 标记成功（独立事务）

## 3. 更新PaymentSuccessListener监听器

修改 [PaymentSuccessListener.java](file:///d:\东北旅游\Northeast-travel\src\main\java\com\example\travelservice\domain\listener\PaymentSuccessListener.java)：

* 注入 `StockDeductLogService`

* 扣库存成功时调用 `stockDeductLogService.markSuccess()`

* 扣库存失败时调用 `stockDeductLogService.recordFail()`

* 使用现有的 `deductTourStock()` 和 `deductProductStock()` 实现

* 根据 `Order.productType` 和 `Order.productId` 字段处理

## 4. 创建定时任务类

在 `job` 包中创建 `StockCompensationJob.java`，包含：

* 定时捞取需要补偿的记录

* 重新执行扣库存逻辑

* 更新补偿状态

## 文件清单

* 新建：`mapper/StockDeductLogMapper.java`

* 新建：`service/StockDeductLogService.java`

* 新建：`job/StockCompensationJob.java`

* 修改：`domain/listener/PaymentSuccessListener.java`

